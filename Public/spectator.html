<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean King 3 - Multi-Bot Spectator</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .connected {
            background: #27ae60;
        }
        
        .disconnected {
            background: #e74c3c;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: normal;
        }
        
        .player-list {
            display: grid;
            gap: 10px;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
            border-left: 4px solid #3498db;
        }
        
        .player-seat {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .player-info h3 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .player-stats {
            font-size: 0.9em;
            color: #bdc3c7;
        }
        
        .player-credits {
            font-size: 1.8em;
            font-weight: bold;
            color: #f39c12;
            text-align: right;
        }
        
        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .ledger-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .page-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 0.9em;
            color: #bdc3c7;
        }
        
        .ledger-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ledger-table thead {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .ledger-table th,
        .ledger-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ledger-table th {
            font-weight: bold;
            color: #3498db;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        
        .ledger-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .amount-negative {
            color: #e74c3c;
        }
        
        .amount-positive {
            color: #27ae60;
        }
        
        .timestamp {
            color: #95a5a6;
            font-size: 0.85em;
        }
        
        /* Player Ledger Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(0, 31, 63, 0.95);
            border: 3px solid #FFD700;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-title {
            font-size: 1.8em;
            color: #FFD700;
        }
        
        .close-btn {
            background: #e74c3c;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .close-btn:hover {
            background: #c0392b;
        }
        
        .player-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-left-width: 6px;
            transform: translateX(2px);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .panel {
                padding: 15px;
            }
            
            .player-card {
                grid-template-columns: auto 1fr;
                grid-template-rows: auto auto;
            }
            
            .player-credits {
                grid-column: 1 / -1;
                text-align: left;
                margin-top: 10px;
            }
            
            .ledger-table {
                font-size: 0.85em;
            }
            
            .ledger-table th,
            .ledger-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üê† Ocean King 3 - Multi-Bot Spectator</h1>
            <div class="connection-status disconnected" id="connectionStatus">
                Disconnected
            </div>
        </header>
        
        <div class="main-grid">
            <div class="panel">
                <div class="panel-title">
                    <span>Players</span>
                    <span class="badge" id="playerCount">0 / 6</span>
                </div>
                <div class="player-list" id="playerList">
                    <p style="text-align: center; color: #95a5a6; padding: 40px 0;">
                        Waiting for players to connect...
                    </p>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">
                    <span>Game Statistics</span>
                </div>
                <div class="game-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="fishCount">0</div>
                        <div class="stat-label">Active Fish</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bulletCount">0</div>
                        <div class="stat-label">Active Bullets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tickRate">0</div>
                        <div class="stat-label">Tick Rate (TPS)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBank">$0</div>
                        <div class="stat-label">Total Bank</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">
                <span>Transaction Ledger</span>
                <span class="badge" id="ledgerCount">0 transactions</span>
            </div>
            <div class="ledger-controls">
                <div class="pagination">
                    <button class="page-btn" id="prevPage" onclick="changePage(-1)" disabled>‚Üê Previous</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button class="page-btn" id="nextPage" onclick="changePage(1)" disabled>Next ‚Üí</button>
                </div>
                <div>
                    <button class="page-btn" onclick="clearLedger()">Clear Ledger</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Player</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #95a5a6; padding: 40px 0;">
                                No transactions yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Player Ledger Modal -->
    <div class="modal-overlay" id="playerLedgerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalPlayerName">Player Ledger</h2>
                <button class="close-btn" onclick="closePlayerLedger()">Close</button>
            </div>
            <div class="ledger-controls">
                <div class="pagination">
                    <button class="page-btn" id="modalPrevPage" onclick="changeModalPage(-1)" disabled>‚Üê Previous</button>
                    <span class="page-info" id="modalPageInfo">Page 1 of 1</span>
                    <button class="page-btn" id="modalNextPage" onclick="changeModalPage(1)" disabled>Next ‚Üí</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="modalLedgerBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #95a5a6; padding: 40px 0;">
                                No transactions yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let connection = null;
        let ledger = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 20;
        let lastTickTime = Date.now();
        let tickCount = 0;
        let tickRate = 0;
        let authToken = null;
        
        // Per-player ledgers
        let playerLedgers = {}; // { playerId: [{time, type, amount, balance, details}] }
        let currentModalPlayer = null;
        let modalCurrentPage = 1;
        
        // Track bullet counts for bet detection
        let previousBulletCounts = {}; // { playerSlot: count }
        
        async function connect() {
            const statusEl = document.getElementById('connectionStatus');
            
            try {
                // First, authenticate as guest spectator
                const authResponse = await fetch('/api/auth/guest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: 'Spectator_' + Date.now() })
                });
                
                if (!authResponse.ok) {
                    throw new Error('Authentication failed');
                }
                
                const authData = await authResponse.json();
                authToken = authData.token;
                
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/gamehub", {
                        accessTokenFactory: () => authToken
                    })
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Information)
                    .build();
                
                connection.on("StateDelta", handleStateDelta);
                
                connection.onreconnecting(() => {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.textContent = 'Reconnecting...';
                });
                
                connection.onreconnected(() => {
                    statusEl.className = 'connection-status connected';
                    statusEl.textContent = 'Connected';
                });
                
                connection.onclose(() => {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.textContent = 'Disconnected';
                });
                
                await connection.start();
                
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'Connected (Spectator Mode)';
                
                console.log("Connected to game hub");
            } catch (err) {
                console.error("Connection failed:", err);
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'Connection Failed';
            }
        }
        
        function handleStateDelta(delta) {
            // Calculate tick rate
            tickCount++;
            const now = Date.now();
            if (now - lastTickTime >= 1000) {
                tickRate = tickCount;
                tickCount = 0;
                lastTickTime = now;
                document.getElementById('tickRate').textContent = tickRate;
            }
            
            // Update players
            if (delta.Players) {
                updatePlayers(delta.Players);
            }
            
            // Update game stats
            if (delta.Fish) {
                document.getElementById('fishCount').textContent = delta.Fish.length;
            }
            
            if (delta.Projectiles && delta.Players) {
                document.getElementById('bulletCount').textContent = delta.Projectiles.length;
                
                // Track bullet counts per player to detect bets
                const currentBulletCounts = {};
                delta.Projectiles.forEach(bullet => {
                    const slot = bullet.PlayerSlot;
                    currentBulletCounts[slot] = (currentBulletCounts[slot] || 0) + 1;
                });
                
                // Detect new bullets (bets)
                for (const [slotStr, newCount] of Object.entries(currentBulletCounts)) {
                    const slot = parseInt(slotStr);
                    const oldCount = previousBulletCounts[slot] || 0;
                    const newBullets = newCount - oldCount;
                    
                    if (newBullets > 0) {
                        const player = delta.Players.find(p => p.PlayerSlot === slot);
                        if (player) {
                            // Record bet transactions
                            for (let i = 0; i < newBullets; i++) {
                                const betEntry = {
                                    time: new Date(),
                                    player: player.DisplayName,
                                    type: 'BET',
                                    amount: -player.BetValue,
                                    balance: player.Credits,
                                    details: `Shot #${oldCount + i + 1}`
                                };
                                addLedgerEntry(betEntry);
                                addPlayerLedgerEntry(slot, {
                                    time: new Date(),
                                    type: 'BET',
                                    amount: -player.BetValue,
                                    balance: player.Credits,
                                    details: `Shot #${oldCount + i + 1}`
                                });
                            }
                        }
                    }
                }
                
                previousBulletCounts = currentBulletCounts;
                renderLedger();
                
                // Update modal if viewing a player
                if (currentModalPlayer !== null) {
                    renderPlayerLedger();
                }
            }
            
            // Handle payout events for ledger
            if (delta.PayoutEvents && delta.PayoutEvents.length > 0) {
                handlePayoutEvents(delta.PayoutEvents, delta.Players);
            }
        }
        
        function updatePlayers(players) {
            const playerListEl = document.getElementById('playerList');
            const playerCountEl = document.getElementById('playerCount');
            const totalBankEl = document.getElementById('totalBank');
            
            if (players.length === 0) {
                playerListEl.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px 0;">Waiting for players to connect...</p>';
                playerCountEl.textContent = '0 / 6';
                totalBankEl.textContent = '$0';
                return;
            }
            
            playerCountEl.textContent = `${players.length} / 6`;
            
            const totalBank = players.reduce((sum, p) => sum + p.Credits, 0);
            totalBankEl.textContent = `$${totalBank.toLocaleString()}`;
            
            playerListEl.innerHTML = players.map(player => `
                <div class="player-card" onclick="openPlayerLedger(${player.PlayerSlot}, '${player.DisplayName}')">
                    <div class="player-seat">P${player.PlayerSlot + 1}</div>
                    <div class="player-info">
                        <h3>${player.DisplayName}</h3>
                        <div class="player-stats">Kills: ${player.TotalKills || 0}</div>
                    </div>
                    <div class="player-credits">$${player.Credits.toLocaleString()}</div>
                </div>
            `).join('');
            
            // Initialize player ledgers if not exists
            players.forEach(player => {
                if (!playerLedgers[player.PlayerSlot]) {
                    playerLedgers[player.PlayerSlot] = [];
                }
            });
        }
        
        function handlePayoutEvents(events, players) {
            if (!events || events.length === 0) return;
            
            // Build player slot to player map
            const playerMap = {};
            players.forEach(p => {
                playerMap[p.PlayerSlot] = p;
            });
            
            events.forEach(event => {
                // Event structure from C# server: { FishId: string, Payout: int, PlayerSlot: int }
                const player = playerMap[event.PlayerSlot];
                if (!player) return;
                
                // Record WIN transaction for this payout
                const winEntry = {
                    time: new Date(),
                    player: player.DisplayName,
                    type: 'WIN',
                    amount: event.Payout,
                    balance: player.Credits,
                    details: `Fish ${event.FishId}`
                };
                
                addLedgerEntry(winEntry);
                addPlayerLedgerEntry(event.PlayerSlot, {
                    time: new Date(),
                    type: 'WIN',
                    amount: event.Payout,
                    balance: player.Credits,
                    details: `Fish ${event.FishId}`
                });
            });
            
            renderLedger();
            
            // Update modal if currently viewing a player
            if (currentModalPlayer !== null) {
                renderPlayerLedger();
            }
        }
        
        function addLedgerEntry(entry) {
            ledger.unshift(entry); // Add to beginning
            
            // Keep only last 1000 entries
            if (ledger.length > 1000) {
                ledger = ledger.slice(0, 1000);
            }
        }
        
        function renderLedger() {
            const ledgerBodyEl = document.getElementById('ledgerBody');
            const ledgerCountEl = document.getElementById('ledgerCount');
            const pageInfoEl = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            ledgerCountEl.textContent = `${ledger.length} transactions`;
            
            if (ledger.length === 0) {
                ledgerBodyEl.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #95a5a6; padding: 40px 0;">No transactions yet</td></tr>';
                return;
            }
            
            const totalPages = Math.ceil(ledger.length / ITEMS_PER_PAGE);
            currentPage = Math.min(currentPage, totalPages);
            
            const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = startIdx + ITEMS_PER_PAGE;
            const pageItems = ledger.slice(startIdx, endIdx);
            
            ledgerBodyEl.innerHTML = pageItems.map(entry => {
                const amountClass = entry.amount >= 0 ? 'amount-positive' : 'amount-negative';
                const amountSign = entry.amount >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td class="timestamp">${entry.time.toLocaleTimeString()}</td>
                        <td>${entry.player}</td>
                        <td>${entry.type}</td>
                        <td class="${amountClass}">${amountSign}$${Math.abs(entry.amount).toLocaleString()}</td>
                        <td>$${entry.balance.toLocaleString()}</td>
                        <td>${entry.details}</td>
                    </tr>
                `;
            }).join('');
            
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
        
        function changePage(delta) {
            const totalPages = Math.ceil(ledger.length / ITEMS_PER_PAGE);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            renderLedger();
        }
        
        function clearLedger() {
            if (confirm('Clear all transaction history?')) {
                ledger = [];
                currentPage = 1;
                renderLedger();
            }
        }
        
        function addPlayerLedgerEntry(playerSlot, entry) {
            if (!playerLedgers[playerSlot]) {
                playerLedgers[playerSlot] = [];
            }
            
            playerLedgers[playerSlot].unshift(entry);
            
            // Keep only last 500 entries per player
            if (playerLedgers[playerSlot].length > 500) {
                playerLedgers[playerSlot] = playerLedgers[playerSlot].slice(0, 500);
            }
        }
        
        function openPlayerLedger(playerSlot, playerName) {
            currentModalPlayer = playerSlot;
            modalCurrentPage = 1;
            document.getElementById('modalPlayerName').textContent = `${playerName} - Transaction Ledger`;
            document.getElementById('playerLedgerModal').classList.add('active');
            renderPlayerLedger();
        }
        
        function closePlayerLedger() {
            document.getElementById('playerLedgerModal').classList.remove('active');
            currentModalPlayer = null;
        }
        
        function renderPlayerLedger() {
            if (currentModalPlayer === null) return;
            
            const playerTransactions = playerLedgers[currentModalPlayer] || [];
            const ledgerBodyEl = document.getElementById('modalLedgerBody');
            const pageInfoEl = document.getElementById('modalPageInfo');
            const prevBtn = document.getElementById('modalPrevPage');
            const nextBtn = document.getElementById('modalNextPage');
            
            if (playerTransactions.length === 0) {
                ledgerBodyEl.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6; padding: 40px 0;">No transactions yet</td></tr>';
                pageInfoEl.textContent = 'Page 1 of 1';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            const totalPages = Math.ceil(playerTransactions.length / ITEMS_PER_PAGE);
            modalCurrentPage = Math.min(modalCurrentPage, totalPages);
            
            const startIdx = (modalCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = startIdx + ITEMS_PER_PAGE;
            const pageItems = playerTransactions.slice(startIdx, endIdx);
            
            ledgerBodyEl.innerHTML = pageItems.map(entry => {
                const amountClass = entry.amount >= 0 ? 'amount-positive' : 'amount-negative';
                const amountSign = entry.amount >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td class="timestamp">${entry.time.toLocaleTimeString()}</td>
                        <td>${entry.type}</td>
                        <td class="${amountClass}">${amountSign}$${Math.abs(entry.amount).toLocaleString()}</td>
                        <td>$${entry.balance.toLocaleString()}</td>
                        <td>${entry.details}</td>
                    </tr>
                `;
            }).join('');
            
            pageInfoEl.textContent = `Page ${modalCurrentPage} of ${totalPages}`;
            prevBtn.disabled = modalCurrentPage === 1;
            nextBtn.disabled = modalCurrentPage >= totalPages;
        }
        
        function changeModalPage(delta) {
            if (currentModalPlayer === null) return;
            
            const playerTransactions = playerLedgers[currentModalPlayer] || [];
            const totalPages = Math.ceil(playerTransactions.length / ITEMS_PER_PAGE);
            modalCurrentPage = Math.max(1, Math.min(totalPages, modalCurrentPage + delta));
            renderPlayerLedger();
        }
        
        // Close modal when clicking outside
        document.getElementById('playerLedgerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePlayerLedger();
            }
        });
        
        // Auto-connect on page load
        window.addEventListener('load', connect);
    </script>
</body>
</html>
